<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:LSPDFREnhancedConfigurator.UI.ViewModels"
        xmlns:models="using:LSPDFREnhancedConfigurator.Models"
        xmlns:views="using:LSPDFREnhancedConfigurator.UI.Views"
        x:Class="LSPDFREnhancedConfigurator.UI.Views.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        Title="LSPDFR Enhanced Configurator"
        Width="1400" Height="900"
        MinWidth="1200" MinHeight="700"
        WindowStartupLocation="CenterScreen">

    <Design.DataContext>
        <vm:MainWindowViewModel/>
    </Design.DataContext>

    <!-- Root grid containing both main content and loading overlay -->
    <Grid>

        <!-- Main Content -->
        <Grid RowDefinitions="Auto,Auto,*,Auto,Auto,Auto">

        <!-- Top Panel with Title -->
        <Border Grid.Row="0"
                Background="{StaticResource DarkerBackgroundBrush}"
                BorderBrush="{StaticResource AccentCyanBrush}"
                BorderThickness="0,0,0,3"
                Padding="24,20">
            <StackPanel Orientation="Horizontal" Spacing="20">
                <Image Source="/Resources/Images/logo-transparent.png"
                       Width="90"
                       Height="87"
                       VerticalAlignment="Center"
                       RenderOptions.BitmapInterpolationMode="HighQuality"/>
                <TextBlock Text="LSPDFR Enhanced Configurator"
                          FontSize="36"
                          FontWeight="Bold"
                          Foreground="{StaticResource AccentCyanBrush}"
                          VerticalAlignment="Center"/>
            </StackPanel>
        </Border>

        <!-- Action Buttons Bar -->
        <Border Grid.Row="1"
                Background="{StaticResource PrimaryDarkBrush}"
                BorderBrush="{StaticResource AccentCyanBrush}"
                BorderThickness="0,0,0,1"
                Padding="16,8">
            <Grid ColumnDefinitions="Auto,Auto,Auto,*,Auto,Auto">

                <!-- Left side: Profile selector -->
                <StackPanel Grid.Column="0"
                           Orientation="Horizontal"
                           Spacing="8"
                           VerticalAlignment="Center">
                    <TextBlock Text="Profile:"
                              Foreground="{StaticResource TextWhiteBrush}"
                              VerticalAlignment="Center"
                              FontSize="14"/>
                    <ComboBox ItemsSource="{Binding AvailableProfiles}"
                             SelectedItem="{Binding SelectedProfile}"
                             MinWidth="200"
                             PlaceholderText="Select a profile..."/>
                </StackPanel>

                <!-- Undo/Redo Buttons -->
                <Button Grid.Column="1"
                       Content="Undo"
                       Command="{Binding UndoCommand}"
                       MinWidth="80"
                       Margin="12,0,0,0"/>

                <Button Grid.Column="2"
                       Content="Redo"
                       Command="{Binding RedoCommand}"
                       MinWidth="80"
                       Margin="8,0,0,0"/>

                <!-- Spacer -->
                <Border Grid.Column="3"/>

                <!-- Right side: Validation Errors -->
                <Button Grid.Column="4"
                       Command="{Binding ShowValidationErrorsCommand}"
                       MinWidth="180"
                       Margin="0,0,12,0"
                       Background="{StaticResource PrimaryDarkBrush}"
                       IsEnabled="{Binding HasAnyValidationIssues}">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <!-- Show only ONE icon based on highest severity (Error > Warning > Advisory > Success) -->
                        <Image Source="/Resources/Icons/error-icon.png"
                              Width="16"
                              Height="16"
                              VerticalAlignment="Center"
                              IsVisible="{Binding HasValidationErrorsOnly}"/>
                        <Image Source="/Resources/Icons/warning-icon.png"
                              Width="16"
                              Height="16"
                              VerticalAlignment="Center">
                            <Image.IsVisible>
                                <MultiBinding Converter="{x:Static BoolConverters.And}">
                                    <Binding Path="HasWarnings"/>
                                    <Binding Path="!HasValidationErrorsOnly"/>
                                </MultiBinding>
                            </Image.IsVisible>
                        </Image>
                        <Image Source="/Resources/Icons/info-icon.png"
                              Width="16"
                              Height="16"
                              VerticalAlignment="Center">
                            <Image.IsVisible>
                                <MultiBinding Converter="{x:Static BoolConverters.And}">
                                    <Binding Path="HasAdvisories"/>
                                    <Binding Path="!HasWarnings"/>
                                    <Binding Path="!HasValidationErrorsOnly"/>
                                </MultiBinding>
                            </Image.IsVisible>
                        </Image>
                        <Image Source="/Resources/Icons/accept-icon.png"
                              Width="16"
                              Height="16"
                              VerticalAlignment="Center"
                              IsVisible="{Binding !HasAnyValidationIssues}"/>
                        <TextBlock Text="{Binding ValidationButtonText}"
                                  VerticalAlignment="Center"/>
                    </StackPanel>
                </Button>

                <!-- Right side: Show/Hide XML Preview -->
                <Button Grid.Column="5"
                       Command="{Binding ToggleXmlPreviewCommand}"
                       MinWidth="170">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <Image Source="/Resources/Icons/show-icon.png"
                              Width="16"
                              Height="16"
                              VerticalAlignment="Center"
                              IsVisible="{Binding !IsXmlPreviewVisible}"/>
                        <Image Source="/Resources/Icons/hide-icon.png"
                              Width="16"
                              Height="16"
                              VerticalAlignment="Center"
                              IsVisible="{Binding IsXmlPreviewVisible}"/>
                        <TextBlock Text="{Binding XmlPreviewButtonText}"
                                  VerticalAlignment="Center"/>
                    </StackPanel>
                </Button>
            </Grid>
        </Border>

        <!-- Main Content Area with Split View -->
        <Grid Grid.Row="2">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <!-- Tab Control -->
            <TabControl Grid.Column="0"
                        SelectedIndex="{Binding CurrentTabIndex}"
                        Padding="8">

                <TabItem Header="Ranks">
                    <views:RanksView DataContext="{Binding RanksViewModel}"/>
                </TabItem>

                <TabItem Header="Station Assignments">
                    <views:StationAssignmentsView DataContext="{Binding StationAssignmentsViewModel}"/>
                </TabItem>

                <TabItem Header="Vehicles">
                    <views:VehiclesView DataContext="{Binding VehiclesViewModel}"/>
                </TabItem>

                <TabItem Header="Outfits">
                    <views:OutfitsView DataContext="{Binding OutfitsViewModel}"/>
                </TabItem>

                <TabItem Header="Settings">
                    <views:SettingsView DataContext="{Binding SettingsViewModel}"/>
                </TabItem>
            </TabControl>

            <!-- GridSplitter for resizable XML Preview -->
            <GridSplitter Grid.Column="1"
                         Width="4"
                         Background="Transparent"
                         ResizeDirection="Columns"
                         IsVisible="{Binding IsXmlPreviewVisible}"/>

            <!-- XML Preview Panel (Side-by-side) -->
            <Border Grid.Column="2"
                    Width="400"
                    MinWidth="300"
                    MaxWidth="800"
                    Background="{StaticResource DarkerBackgroundBrush}"
                    BorderBrush="{StaticResource AccentCyanBrush}"
                    BorderThickness="2,0,0,0"
                    IsVisible="{Binding IsXmlPreviewVisible}">
                <Grid RowDefinitions="Auto,*">
                    <!-- Header with title and theme toggle -->
                    <Grid Grid.Row="0" ColumnDefinitions="*,Auto" Margin="12,12,12,8">
                        <TextBlock Grid.Column="0"
                                  Text="XML Preview"
                                  FontSize="16"
                                  FontWeight="Bold"
                                  Foreground="{StaticResource AccentCyanBrush}"
                                  VerticalAlignment="Center"/>

                        <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="12" VerticalAlignment="Center" HorizontalAlignment="Center">
                            <TextBlock Text="Light"
                                      Foreground="{StaticResource TextWhiteBrush}"
                                      VerticalAlignment="Center"
                                      FontSize="11"/>
                            <ToggleSwitch IsChecked="{Binding IsXmlPreviewDarkMode}"
                                         OffContent=""
                                         OnContent=""
                                         BorderBrush="{StaticResource AccentCyanBrush}"
                                         BorderThickness="2"
                                         ToolTip.Tip="Toggle between Light and Dark theme for XML preview"/>
                            <TextBlock Text="Dark"
                                      Foreground="{StaticResource TextWhiteBrush}"
                                      VerticalAlignment="Center"
                                      FontSize="11"/>
                        </StackPanel>
                    </Grid>

                    <ScrollViewer Grid.Row="1" Margin="12,0,12,12">
                        <TextBox Text="{Binding XmlPreviewText, Mode=OneWay}"
                                FontFamily="Consolas,Courier New,monospace"
                                Background="{Binding XmlPreviewBackground}"
                                Foreground="{Binding XmlPreviewForeground}"
                                IsReadOnly="True"
                                TextWrapping="Wrap"
                                AcceptsReturn="True"
                                Focusable="False"
                                Cursor="Arrow"
                                BorderThickness="1"
                                BorderBrush="{StaticResource AccentCyanBrush}"/>
                    </ScrollViewer>
                </Grid>
            </Border>
        </Grid>

        <!-- Validation Errors Panel (Below tabs) -->
        <Border Grid.Row="3"
                Background="{StaticResource DarkerBackgroundBrush}"
                BorderBrush="{StaticResource WarningOrangeBrush}"
                BorderThickness="0,2,0,0"
                Padding="16,12"
                MinHeight="150"
                MaxHeight="300"
                Height="200"
                IsVisible="{Binding IsValidationPanelVisible}">
            <Grid RowDefinitions="Auto,*">
                <StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="10" Margin="0,0,0,8">
                    <Image Source="/Resources/Icons/error-icon.png"
                          Width="20"
                          Height="20"
                          VerticalAlignment="Center"
                          IsVisible="{Binding HasValidationErrorsOnly}"/>
                    <Image Source="/Resources/Icons/warning-icon.png"
                          Width="20"
                          Height="20"
                          VerticalAlignment="Center"
                          IsVisible="{Binding HasWarnings}"/>
                    <Image Source="/Resources/Icons/info-icon.png"
                          Width="20"
                          Height="20"
                          VerticalAlignment="Center"
                          IsVisible="{Binding HasAdvisories}"/>
                    <Image Source="/Resources/Icons/accept-icon.png"
                          Width="20"
                          Height="20"
                          VerticalAlignment="Center"
                          IsVisible="{Binding !HasAnyValidationIssues}"/>
                    <TextBlock Text="Validation Errors"
                              FontSize="16"
                              FontWeight="Bold"
                              Foreground="{StaticResource WarningOrangeBrush}"
                              VerticalAlignment="Center"/>
                </StackPanel>

                <DataGrid Grid.Row="1"
                         ItemsSource="{Binding ValidationErrorItems}"
                         AutoGenerateColumns="False"
                         CanUserResizeColumns="True"
                         CanUserSortColumns="True"
                         GridLinesVisibility="Horizontal"
                         IsReadOnly="True"
                         SelectionMode="Single"
                         Background="{StaticResource PrimaryDarkBrush}"
                         RowBackground="{StaticResource PrimaryDarkBrush}"
                         BorderBrush="{StaticResource WarningOrangeBrush}"
                         BorderThickness="1"
                         HeadersVisibility="Column">

                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Type"
                                          Binding="{Binding Type}"
                                          Width="80"/>

                        <DataGridTextColumn Header="Category"
                                          Binding="{Binding Severity}"
                                          Width="100"/>

                        <DataGridTextColumn Header="Rank"
                                          Binding="{Binding RankName}"
                                          Width="150"/>

                        <DataGridTextColumn Header="Item"
                                          Binding="{Binding ItemName}"
                                          Width="150"/>

                        <DataGridTextColumn Header="Message"
                                          Binding="{Binding Message}"
                                          Width="*"
                                          MinWidth="200"/>

                        <DataGridTemplateColumn Header="Actions" Width="160">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate DataType="models:ValidationErrorItem">
                                    <StackPanel Orientation="Horizontal" Spacing="4" HorizontalAlignment="Center">
                                        <!-- Show Button -->
                                        <Button Command="{Binding ShowCommand}"
                                               IsVisible="{Binding CanShow}"
                                               Padding="6,3"
                                               MinWidth="60">
                                            <StackPanel Orientation="Horizontal" Spacing="4">
                                                <Image Source="/Resources/Icons/info-icon.png"
                                                      Width="12"
                                                      Height="12"
                                                      VerticalAlignment="Center"/>
                                                <TextBlock Text="Show"
                                                          VerticalAlignment="Center"
                                                          FontSize="11"/>
                                            </StackPanel>
                                        </Button>

                                        <!-- Remove Button -->
                                        <Button Command="{Binding RemoveCommand}"
                                               IsVisible="{Binding CanRemove}"
                                               Padding="6,3"
                                               MinWidth="70">
                                            <StackPanel Orientation="Horizontal" Spacing="4">
                                                <Image Source="/Resources/Icons/delete-icon.png"
                                                      Width="12"
                                                      Height="12"
                                                      VerticalAlignment="Center"/>
                                                <TextBlock Text="Remove"
                                                          VerticalAlignment="Center"
                                                          FontSize="11"/>
                                            </StackPanel>
                                        </Button>

                                        <!-- No Actions Text -->
                                        <TextBlock Text="{Binding ActionsText}"
                                                  IsVisible="{Binding NoActionsAvailable}"
                                                  VerticalAlignment="Center"
                                                  FontSize="11"
                                                  Foreground="{StaticResource TextGrayBrush}"/>
                                    </StackPanel>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                    </DataGrid.Columns>
                </DataGrid>
            </Grid>
        </Border>

        <!-- Bottom Button Panel -->
        <Border Grid.Row="4"
                Background="{StaticResource DarkerBackgroundBrush}"
                BorderBrush="{StaticResource AccentCyanBrush}"
                BorderThickness="0,2,0,0"
                Padding="16,12">
            <Grid ColumnDefinitions="Auto,*,Auto,Auto">
                <!-- Left side: Restore from Backup -->
                <Button Grid.Column="0"
                       Command="{Binding RestoreBackupCommand}"
                       MinWidth="180">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <Image Source="/Resources/Icons/refresh-icon.png"
                              Width="16"
                              Height="16"
                              VerticalAlignment="Center"/>
                        <TextBlock Text="Restore from Backup"
                                  VerticalAlignment="Center"/>
                    </StackPanel>
                </Button>

                <!-- Spacer -->
                <Border Grid.Column="1"/>

                <!-- Right side buttons -->
                <Button Grid.Column="2"
                       Command="{Binding GenerateCommand}"
                       MinWidth="140"
                       IsEnabled="{Binding !IsLoading}"
                       Margin="0,0,12,0">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <Image Source="/Resources/Icons/accept-icon.png"
                              Width="16"
                              Height="16"
                              VerticalAlignment="Center"
                              IsVisible="{Binding !HasValidationErrors}"/>
                        <Image Source="/Resources/Icons/warning-icon.png"
                              Width="16"
                              Height="16"
                              VerticalAlignment="Center"
                              IsVisible="{Binding HasValidationErrors}"/>
                        <TextBlock Text="Generate XML"
                                  VerticalAlignment="Center"/>
                    </StackPanel>
                </Button>
                <Button Grid.Column="3"
                       Command="{Binding ExitCommand}"
                       MinWidth="100">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <Image Source="/Resources/Icons/exit-icon.png"
                              Width="16"
                              Height="16"
                              VerticalAlignment="Center"/>
                        <TextBlock Text="Exit"
                                  VerticalAlignment="Center"/>
                    </StackPanel>
                </Button>
            </Grid>
        </Border>

        <!-- Status Bar -->
        <Border Grid.Row="5"
                Background="{StaticResource DarkerBackgroundBrush}"
                BorderBrush="{StaticResource InputBorderBrush}"
                BorderThickness="0,1,0,0"
                Padding="16,8">
            <Grid ColumnDefinitions="Auto,*,Auto">
                <!-- Loaded data summary -->
                <TextBlock Grid.Column="0"
                          Text="{Binding LoadedDataSummary}"
                          Foreground="{StaticResource TextGrayBrush}"
                          FontSize="12"
                          VerticalAlignment="Center"
                          Margin="0,0,20,0"/>

                <!-- Status message -->
                <TextBlock Grid.Column="1"
                          Text="{Binding StatusMessage}"
                          Foreground="{StaticResource TextWhiteBrush}"
                          VerticalAlignment="Center"/>

                <!-- Debug logging indicator and loading indicator -->
                <StackPanel Grid.Column="2"
                           Orientation="Horizontal"
                           Spacing="16">

                    <!-- Debug logging enabled indicator -->
                    <Border Background="#28FFB84D"
                           BorderBrush="{StaticResource WarningOrangeBrush}"
                           BorderThickness="1"
                           Padding="8,4"
                           CornerRadius="3"
                           IsVisible="{Binding IsDebugLoggingEnabled}">
                        <StackPanel Orientation="Horizontal" Spacing="6">
                            <Image Source="/Resources/Icons/warning-icon.png"
                                  Width="16"
                                  Height="16"
                                  VerticalAlignment="Center"/>
                            <TextBlock Text="Debug Logging Enabled"
                                      Foreground="{StaticResource WarningOrangeBrush}"
                                      FontSize="11"
                                      FontWeight="SemiBold"
                                      VerticalAlignment="Center"/>
                        </StackPanel>
                    </Border>

                    <!-- Loading indicator -->
                    <StackPanel Orientation="Horizontal"
                               Spacing="8"
                               IsVisible="{Binding IsLoading}">
                        <TextBlock Text="Loading..."
                                  Foreground="{StaticResource AccentCyanBrush}"
                                  VerticalAlignment="Center"/>
                    </StackPanel>

                </StackPanel>
            </Grid>
        </Border>

        </Grid>
        <!-- End Main Content -->

        <!-- Loading Overlay -->
        <Border Background="#DD000000"
                IsVisible="{Binding IsLoading}"
                ZIndex="1000">
            <Grid RowDefinitions="*,Auto,Auto,Auto">

                <!-- Logo and Title -->
                <StackPanel Grid.Row="0"
                           VerticalAlignment="Center"
                           HorizontalAlignment="Center"
                           Spacing="16">
                    <Image Source="/Resources/Images/logo-transparent.png"
                           Width="100"
                           Height="97"
                           HorizontalAlignment="Center"
                           RenderOptions.BitmapInterpolationMode="HighQuality"/>
                    <TextBlock Text="LSPDFR Enhanced Configurator"
                              FontSize="20"
                              FontWeight="Bold"
                              Foreground="{StaticResource AccentCyanBrush}"
                              HorizontalAlignment="Center"/>
                </StackPanel>

                <!-- Progress Bar -->
                <StackPanel Grid.Row="1"
                           Width="500"
                           Margin="0,0,0,20"
                           Spacing="12">
                    <TextBlock Text="{Binding LoadingStatusText}"
                              FontSize="14"
                              FontWeight="SemiBold"
                              Foreground="{Binding LoadingStatusForeground}"
                              HorizontalAlignment="Center"/>
                    <ProgressBar Value="{Binding LoadingProgress}"
                                Minimum="0"
                                Maximum="100"
                                Height="12"
                                IsIndeterminate="{Binding IsLoadingIndeterminate}"
                                Foreground="{Binding LoadingProgressForeground}"
                                Background="{StaticResource InputBackgroundBrush}"
                                BorderBrush="{Binding LoadingProgressBorderBrush}"
                                BorderThickness="1"/>
                </StackPanel>

                <!-- Status Message -->
                <Border Grid.Row="2"
                        Background="{StaticResource DarkerBackgroundBrush}"
                        BorderBrush="{StaticResource InputBorderBrush}"
                        BorderThickness="0,1,0,0"
                        Padding="20,12">
                    <TextBlock Text="{Binding LoadingDetailText}"
                              FontSize="11"
                              Foreground="{StaticResource TextGrayBrush}"
                              HorizontalAlignment="Center"
                              TextWrapping="Wrap"
                              MaxWidth="600"/>
                </Border>

                <!-- Error Action Buttons (only visible when HasLoadingError is true) -->
                <StackPanel Grid.Row="3"
                           Orientation="Vertical"
                           HorizontalAlignment="Center"
                           Spacing="16"
                           Margin="0,20,0,40"
                           IsVisible="{Binding HasLoadingError}">

                    <!-- Primary action buttons -->
                    <StackPanel Orientation="Horizontal"
                               HorizontalAlignment="Center"
                               Spacing="12">
                        <Button MinWidth="140"
                               Command="{Binding RetryLoadCommand}">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <Image Source="/Resources/Icons/refresh-icon.png"
                                      Width="16"
                                      Height="16"
                                      VerticalAlignment="Center"/>
                                <TextBlock Text="Retry Loading"
                                          VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                        <Button Content="Close"
                               MinWidth="120"
                               Command="{Binding CloseApplicationCommand}"/>
                        <Button MinWidth="140"
                               Command="{Binding OpenLogFileCommand}">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <Image Source="/Resources/Icons/info-icon.png"
                                      Width="16"
                                      Height="16"
                                      VerticalAlignment="Center"/>
                                <TextBlock Text="Open Log File"
                                          VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                        <Button MinWidth="180"
                               Command="{Binding RestoreFromBackupCommand}">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <Image Source="/Resources/Icons/restore-icon.png"
                                      Width="16"
                                      Height="16"
                                      VerticalAlignment="Center"/>
                                <TextBlock Text="Restore from Backup"
                                          VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                    </StackPanel>

                    <!-- Advanced option: Open Ranks.xml -->
                    <Border Background="#554400"
                           BorderBrush="#FFAA00"
                           BorderThickness="1"
                           CornerRadius="4"
                           Padding="12,8"
                           MaxWidth="600"
                           ToolTip.Tip="Advanced users can attempt to manually resolve Ranks.xml themselves">
                        <StackPanel Orientation="Horizontal"
                                   HorizontalAlignment="Center"
                                   Spacing="12">
                            <Image Source="/Resources/Icons/warning-icon.png"
                                  Width="20"
                                  Height="20"
                                  VerticalAlignment="Center"/>
                            <TextBlock Text="Advanced users can manually edit Ranks.xml:"
                                      Foreground="#FFAA00"
                                      VerticalAlignment="Center"
                                      FontSize="12"/>
                            <Button Command="{Binding OpenRanksXmlCommand}"
                                   Background="#665500"
                                   BorderBrush="#FFAA00"
                                   MinWidth="140">
                                <StackPanel Orientation="Horizontal" Spacing="8">
                                    <Image Source="/Resources/Icons/gear-icon.png"
                                          Width="16"
                                          Height="16"
                                          VerticalAlignment="Center"/>
                                    <TextBlock Text="Open Ranks.xml"
                                              Foreground="#FFCC00"
                                              VerticalAlignment="Center"/>
                                </StackPanel>
                            </Button>
                        </StackPanel>
                    </Border>
                </StackPanel>

            </Grid>
        </Border>
        <!-- End Loading Overlay -->

    </Grid>
</Window>
