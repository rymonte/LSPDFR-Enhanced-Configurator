name: Build & Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (leave empty for auto-increment patch, or specify like 2.0.0)'
        required: false
        type: string

jobs:
  release:
    runs-on: windows-latest
    permissions:
      contents: write  # Needed for creating releases and pushing tags

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for changelog
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Calculate version
        id: version
        shell: pwsh
        run: |
          # Read current version from project file
          $projectFile = "LSPDFREnhancedConfigurator/LSPDFREnhancedConfigurator.csproj"
          [xml]$proj = Get-Content $projectFile

          $currentVersion = $proj.Project.PropertyGroup.Version
          Write-Host "Current version in project: $currentVersion"

          # If manual version provided, use it
          if ("${{ inputs.version }}" -ne "") {
            $newVersion = "${{ inputs.version }}"
            Write-Host "Using manual version: $newVersion"
          } else {
            # Auto-increment patch version
            if ($currentVersion -match '^(\d+)\.(\d+)\.(\d+)') {
              $major = [int]$matches[1]
              $minor = [int]$matches[2]
              $patch = [int]$matches[3] + 1
              $newVersion = "$major.$minor.$patch"
              Write-Host "Auto-incremented to: $newVersion"
            } else {
              Write-Error "Could not parse current version: $currentVersion"
              exit 1
            }
          }

          # Remove -BETA suffix if present
          $newVersion = $newVersion -replace '-BETA$', ''

          # Output for use in later steps
          echo "version=$newVersion" >> $env:GITHUB_OUTPUT
          echo "NEW_VERSION=$newVersion" >> $env:GITHUB_ENV

      - name: Update project version
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $projectFile = "LSPDFREnhancedConfigurator/LSPDFREnhancedConfigurator.csproj"

          [xml]$proj = Get-Content $projectFile

          # Update all version properties
          $proj.Project.PropertyGroup.Version = $version
          $proj.Project.PropertyGroup.AssemblyVersion = $version
          $proj.Project.PropertyGroup.FileVersion = $version

          $proj.Save((Resolve-Path $projectFile))

          Write-Host "Updated project version to: $version"

      - name: Restore dependencies
        run: dotnet restore

      - name: Build and Publish x64
        run: |
          dotnet publish LSPDFREnhancedConfigurator/LSPDFREnhancedConfigurator.csproj `
            --configuration Release `
            --runtime win-x64 `
            --self-contained false `
            --output ./publish/win-x64 `
            -p:PublishSingleFile=true `
            -p:PublishReadyToRun=true `
            -p:PublishTrimmed=false

      - name: Build and Publish x86
        run: |
          dotnet publish LSPDFREnhancedConfigurator/LSPDFREnhancedConfigurator.csproj `
            --configuration Release `
            --runtime win-x86 `
            --self-contained false `
            --output ./publish/win-x86 `
            -p:PublishSingleFile=true `
            -p:PublishReadyToRun=true `
            -p:PublishTrimmed=false

      - name: Package builds
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"

          # Create zip for x64
          Compress-Archive -Path "./publish/win-x64/*" `
            -DestinationPath "LSPDFREnhancedConfigurator-v$version-win-x64.zip" `
            -Force

          # Create zip for x86
          Compress-Archive -Path "./publish/win-x86/*" `
            -DestinationPath "LSPDFREnhancedConfigurator-v$version-win-x86.zip" `
            -Force

          Write-Host "Created release packages"

      - name: Commit version bump
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add LSPDFREnhancedConfigurator/LSPDFREnhancedConfigurator.csproj
          git commit -m "chore: bump version to ${{ steps.version.outputs.version }}"
          git push

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: LSPDFR Enhanced Configurator v${{ steps.version.outputs.version }}
          generate_release_notes: true
          draft: false
          prerelease: false
          files: |
            LSPDFREnhancedConfigurator-v${{ steps.version.outputs.version }}-win-x64.zip
            LSPDFREnhancedConfigurator-v${{ steps.version.outputs.version }}-win-x86.zip
